<!DOCTYPE html>
<html charset="utf-8">
<head>
<title>P4VE video decoder</title>
<script>

function init()
{
  document.querySelector('input').addEventListener('change', extractFrames, false);
}

function extractFrames() {
  var video = document.createElement('video');
  var canvas = document.createElement('canvas');
  var ctx = canvas.getContext('2d');
  var prog = document.createElement('pre');
  var log = document.createElement('pre');
  var result = [], state = 0, filename="", srcPath = this.files[0];

  var output = document.querySelector('#output');
  output.appendChild(document.createElement('hr'));
  output.appendChild(prog);
  output.appendChild(log);
  log.style = "margin-left:2em;background-color:#eee;"

  function initCanvas(e) {
    canvas.width = this.videoWidth;
    canvas.height = this.videoHeight;
    result = [];
    log.innerHTML = "started.<br>";
  }

  function term() {
    log.innerHTML += "done.<br>";
  }


  function save(filename) {
    const link = document.createElement('a');
    if (link.download !== undefined) {
        function concatBuffers(bufs) {
            var offset = 0, bytes = 0;
            var bufs2 = bufs.map(function(buf, total) {
                bytes += buf.byteLength;
                return buf;
            });
            var buffer = new ArrayBuffer(bytes);
            var store = new Uint8Array(buffer);
            bufs2.forEach(function(buf){
                store.set(new Uint8Array(buf.buffer||buf, buf.byteOffset), offset);
                offset += buf.byteLength;
            });
            return buffer;
        }
        const blob = new Blob([concatBuffers(result)]);
        var url = URL.createObjectURL(blob)
        link.setAttribute('href', url);
        link.setAttribute('download', filename+".txt");
        link.click();
        log.innerHTML += "Saved : " + filename + "<br>";
        URL.revokeObjectURL(url)
    }
  }
  
  function getMatchRate(a, b)
  {
    var n = Math.min(a.length, b.length), m = 0;
    for(var i=0; i < n; i++)
    {
      if (a[i] == b[i]) m++;
    }
    console.log(a.length, b.length, m, n);
    return m / n;
  }

  function drawFrame(e) {
    ctx.drawImage(this, 0, 0);

    var w = this.videoWidth, h = this.videoHeight
    var data = ctx.getImageData(0, 0, w, h).data;

    var numBits = (h >> 3) * (w >> 3);
    var tmpUnicode = new Uint16Array(numBits / 16);
    var tmpAscii = new Uint8Array(numBits / 8);
    var wp = 0, v = 0;
    var ymax = (state == 0) ? 40 : h;
    for(var y=4; y < ymax; y += 16)
    {
        for(var x=4; x < w; x += 16)
        {
            var i = (y * w * 4 + x * 4);
            var bit0 = (data[i] > 127) ? 1 : 0;
            var bit1 = (data[i + 32] > 127) ? 2 : 0;
            var bit2 = (data[i + 32 * w] > 127) ? 4 : 0;
            var bit3 = (data[i + 32 * w + 32] > 127) ? 8 : 0;
            v = (v >> 4) | ((bit0 | bit1 | bit2 | bit3) << 12);
            wp++;
            if ((wp & 3) == 0)
            {
              var p = wp >> 2;
              tmpUnicode[p] = v;
              tmpAscii[p] = v;
              v = 0;
            }
        }
    }

    tmpUnicode = tmpUnicode.filter(x => (x>0));
    tmpAscii = tmpAscii.filter(x => (x>0));
    var hstr = new TextDecoder().decode(tmpAscii);
    switch(state)
    {
      case 0:
        if (hstr.startsWith("START:"))
        {
          state = 1;
          var args = hstr.split(":");
          filename = args[args.length - 1];
          log.innerHTML += "Detect : " + filename + "<br>";
        } 
        break;
        
      case 1:
        if (hstr.startsWith("START:")) break;
        if (hstr.startsWith("END:")) { save(filename); state = 0; break; }
        if (tmpUnicode.length > 0) {
          if (result.length == 0 || getMatchRate(result[result.length - 1], tmpUnicode) < 0.99) {
            result.push(tmpUnicode);
          }
        }
        break;
    }

    prog.innerHTML = "Processing " + srcPath.name + " : " + ~~(this.currentTime / this.duration * 100) + "%";
    if (this.currentTime < this.duration) {
      this.currentTime += (state == 0) ? (1.0 / 20.0) : (1.0 / 32.0);
    }
    else
    {
      term();
    }
  }
  
  video.muted = true;
  video.addEventListener('loadedmetadata', initCanvas, false);
  video.addEventListener('timeupdate', drawFrame, false);
  video.src = URL.createObjectURL(srcPath);
  video.currentTime = 1.0 / 60.0;
}
</script>
</head>

<body onload="init()">
<p>
P4VE を使って作成した動画を選択してください。変換はオフラインで行われます。<br>
変換後のテキストは UTF-16(LE) です。プチコン固有の文字は崩れます。<br>
</p>
<p>
Select a video that has made by P4VE. The conversion is done offline.<br>
Converted text is UTF-16(LE). Petitcom-dependent characters will not be shown.<br>
</p>
<p><input type="file" accept="video/*"/></p>
<div id="output"></div>
</body>
</html>
